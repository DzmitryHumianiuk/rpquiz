resource_types:
- name: ssh
  type: docker-image
  source:
    repository: quay.io/avarabyeu/concourse-ssh-resource:latest

resources:
- name: rpquiz-git
  type: git
  source:
    uri: git@gitlab.com:avarabyeu/rpquiz.git
    branch: master
    private_key: ((repo_key))

- name: rpquiz-docker-image
  type: docker-image
  source:
    repository: registry.gitlab.com/avarabyeu/rpquiz
    username: ((docker_login))
    password: ((docker_pass))

- name: staging-server
  type: ssh
  source:
    host: ((deploy_host))
    user: ((deploy_host_user))
    password: ((deploy_host_password))

jobs:
- name: build
  public: true
  serial: true
  plan:
  - get: rpquiz-git
    trigger: true
  - put: rpquiz-docker-image
    get_params: { skip_download: true }
    params:
      cache: true
      params: {save: true}
      build: rpquiz-git
      dockerfile: rpquiz-git/DockerfileProd

  # Second job: Retrieve application from S3 Bucket and Deploy to Docker Server
- name: Deploy
  plan:
  - get: rpquiz-docker-image
    trigger: true
    # Only if build job has passed
    passed: [build]
  - put: staging-server
    params:
      interpreter: /bin/sh
      script: |
        docker stop rpquiz
        docker rm -v -f rpquiz
        docker login -u "<docker_login>" -p "<docker_pass>" registry.gitlab.com
        docker pull registry.gitlab.com/avarabyeu/rpquiz
        docker run -d -p 4200:4200 --restart=always --name rpquiz registry.gitlab.com/avarabyeu/rpquiz/rpquiz
      placeholders:
      - name: "<docker_login>"
        value: ((repo_key))
      - name: "<docker_pass>"
        value: ((docker_pass))